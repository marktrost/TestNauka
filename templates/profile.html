{% extends "base.html" %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - {{ session.username }}{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item active">üìä –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h5>
            </div>
            <div class="card-body text-center">
                <div class="avatar mb-3">
                    <span style="font-size: 3rem;">üéì</span>
                </div>
                <h4>{{ session.username }}</h4>
                <p class="text-muted">–£—á–∞—Å—Ç–Ω–∏–∫ —Å {{ user_data.created_at[:10] }}</p>

                <div class="row text-center">
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <h5 class="mb-0">{{ total_tests }}</h5>
                            <small>–¢–µ—Å—Ç–æ–≤</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <h5 class="mb-0">{{ average_percentage|round(1) }}%</h5>
                            <small>–°—Ä–µ–¥–Ω–∏–π</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º -->
        <div class="card">
            <div class="card-header">
                <h5>üìö –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h5>
            </div>
            <div class="card-body">
                {% for progress in subject_progress %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>{{ progress.subject_name }}</span>
                        <small class="fw-bold">{{ progress.correct_answered }}/{{ progress.total_answered }}</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        {% set percent = (progress.correct_answered / progress.total_answered * 100) if progress.total_answered > 0 else 0 %}
                        <div class="progress-bar {% if percent >= 80 %}bg-success{% elif percent >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                             style="width: {{ percent }}%">
                        </div>
                    </div>
                    <small class="text-muted">{{ percent|round(1) }}%</small>
                </div>
                {% else %}
                <p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏—Å—Ç–æ—Ä–∏—è –∏ –≥—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="col-md-8">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h2>‚è±Ô∏è</h2>
                        <h4>{{ total_time|round(1) }}—á</h4>
                        <small>–í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h2>‚úÖ</h2>
                        <h4>{{ total_correct }}</h4>
                        <small>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h2>üìà</h2>
                        <h4>{{ best_score }}%</h4>
                        <small>–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤ -->
        <div class="card">
            <div class="card-header">
                <h5>üìã –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤</h5>
            </div>
            <div class="card-body">
                {% if test_results %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–í–∞—Ä–∏–∞–Ω—Ç</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–í—Ä–µ–º—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in test_results %}
                            <tr>
                                <td>{{ result.completed_at[:16] }}</td>
                                <td>{{ result.variant_name }}</td>
                                <td>
                                    <span class="badge bg-{% if result.percentage >= 70 %}success{% elif result.percentage >= 50 %}warning{% else %}danger{% endif %}">
                                        {{ result.score }}/{{ result.total_questions }} ({{ result.percentage|round(1) }}%)
                                    </span>
                                </td>
                                <td>{{ (result.time_spent / 60)|round(1) }} –º–∏–Ω.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <h5>üìù –ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</h5>
                    <p class="text-muted">–ù–∞—á–Ω–∏—Ç–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –∫ –ï–ù–¢ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</p>
                    <a href="{{ url_for('index') }}" class="btn btn-primary">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}